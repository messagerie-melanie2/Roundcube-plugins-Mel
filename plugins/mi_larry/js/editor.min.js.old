function rcube_text_editor(e,t){var i=this,n=location.href.replace(/[?#].*$/,"").replace(/\/$/,""),r={selector:"#"+($("#"+t).is(".mce_editor")?t:"fake-editor-id"),cache_suffix:"s=4050800",theme:"modern",language:e.lang,content_css:rcmail.assets_path("program/resources/tinymce/content.css"),menubar:!1,statusbar:!1,toolbar_items_size:"small",extended_valid_elements:"font[face|size|color|style],span[id|class|align|style]",fontsize_formats:"8pt 9pt 10pt 11pt 12pt 14pt 18pt 24pt 36pt",relative_urls:!1,remove_script_host:!1,convert_urls:!1,image_description:!1,paste_webkit_style:"color font-size font-family",paste_data_images:!0,browser_spellcheck:!0};this.spellcheck_observer=function(){},e.spellchecker&&(this.spellchecker=e.spellchecker,e.spellcheck_observer&&(this.spellchecker.spelling_state_observer=this.spellcheck_observer=e.spellcheck_observer)),tinymce.registered_request_token||(tinymce.registered_request_token=!0,tinymce.util.XHR.on("beforeSend",function(e){e.xhr.setRequestHeader("X-Roundcube-Request",rcmail.env.request_token)})),"identity"==e.mode?$.extend(r,{plugins:"autolink charmap code colorpicker hr image link paste tabfocus textcolor",toolbar:"bold italic underline alignleft aligncenter alignright alignjustify | outdent indent charmap hr link unlink image code forecolor | fontselect fontsizeselect",file_browser_callback:function(e,t,n,r){i.file_browser_callback(e,t,n)},file_browser_callback_types:"image"}):$.extend(r,{plugins:"autolink charmap code colorpicker directionality link lists image media nonbreaking paste table tabfocus textcolor searchreplace spellchecker",toolbar:"undo redo | bold italic underline strikethrough | outdent indent | alignleft aligncenter alignright alignjustify | bullist numlist blockquote | forecolor backcolor | fontselect fontsizeselect | link unlink",spellchecker_rpc_url:n+"/?_task=utils&_action=spell_html&_remote=1",spellchecker_language:rcmail.env.spell_lang,accessibility_focus:!1,file_browser_callback:function(e,t,n,r){i.file_browser_callback(e,t,n)},file_browser_callback_types:"image media"}),$.each(e.extra_plugins||[],function(){r.plugins.indexOf(this)<0&&(r.plugins=r.plugins+" "+this)}),$.each(e.extra_buttons||[],function(){r.toolbar.indexOf(this)<0&&(r.toolbar=r.toolbar.replace("$extra","$extra "+this))}),$.each(e.disabled_plugins||[],function(){r.plugins=r.plugins.replace(this,"")}),$.each(e.disabled_buttons||[],function(){r.toolbar=r.toolbar.replace(this,"")}),r.toolbar=r.toolbar.replace("$extra","").replace(/\|\s+\|/g,"|"),window.rcmail_editor_settings&&$.extend(r,window.rcmail_editor_settings),r.setup=function(e){e.on("init",function(e){i.init_callback(e)}),e.on("SpellcheckStart SpellcheckEnd",function(e){i.spellcheck_active="spellcheckstart"==e.type,i.spellcheck_observer()}),e.on("keypress",function(){rcmail.compose_type_activity++})},this.id=t,this.editor=null,tinymce.init(r),this.init_callback=function(e){if(this.editor=e.target,"compose"==rcmail.env.action){var t=$("#"+this.id),n=$("div.mce-toolbar-grp:first",t.parent()).height();if(n>200||n>t.height())return setTimeout(function(){i.init_callback(e)},300);var r={},l=rcube_find_object("_from"),s=rcmail.env.compose_focus_elem;rcmail.env.default_font&&(r["font-family"]=rcmail.env.default_font),rcmail.env.default_font_size&&(r["font-size"]=rcmail.env.default_font_size),(r["font-family"]||r["font-size"])&&$(this.editor.getBody()).css(r),l&&"select-one"==l.type&&(rcmail.env.identities_initialized||rcmail.change_identity(l),s&&s.id!=this.id&&"BODY"!=s.nodeName&&(window.focus(),s.focus(),rcmail.env.compose_focus_elem=null)),i.tabindex(s&&s.id==i.id),$(window).resize()}},this.tabindex=function(e){if("mail"==rcmail.env.task&&this.editor){var t=this.editor.getElement(),n=this.editor.getBody(),r=this.editor.getContentAreaContainer().childNodes[0];if(t&&r&&(r.tabIndex=t.tabIndex),t.tabIndex>0){var l=null,s=[":prev",":next"],o=tinymce.DOM.select("*[tabindex="+t.tabIndex+"]:not(iframe)");tinymce.each(o,function(e,t){if(e.id==i.id)return l=t,!1}),null!==l&&(o[l-1]&&o[l-1].id&&(s[0]=o[l-1].id),o[l+1]&&o[l+1].id&&(s[1]=o[l+1].id),this.editor.settings.tabfocus_elements=s.join(","))}bw.mz&&bw.vendver<25&&$(n).prop("contenteditable",!1).prop("contenteditable",!0),e&&n.focus()}},this.toggle=function(e,t){var n,r,l,s=$("#"+this.id),o=rcmail.env.identity?rcmail.env.signatures[rcmail.env.identity]:null,a=o&&o.text&&o.text.length>1;if(this.spellcheck_stop(),e){r=s.val(),a&&(r=r.replace(/\r\n/,"\n"),r=r.replace(o.text.replace(/\r\n/,"\n"),""));var c=function(e){if(a&&(e=e.replace("",'<div id="_rc_sig">'+o.html+"</div>")),s.val(e),tinymce.execCommand("mceAddEditor",!1,i.id),i.editor){var t=$(i.editor.getBody());i.tabindex(!0),i.editor.selection.setCursorLocation(t.children().first().get(0))}};t?(c(r),l=!0):l=rcmail.plain2html(r,c)}else if(this.editor){a&&((n=this.editor.dom.get("_rc_sig"))&&(n=n.innerHTML),this.editor.dom.setHTML("_rc_sig","")),r=this.editor.getContent();var d=function(e){tinymce.execCommand("mceRemoveEditor",!1,i.id),i.editor=null,a&&(e=e.replace("","\n"+o.text)),s.val(e).focus(),rcmail.set_caret_pos(s.get(0),0)};t?(d(s.val()),l=!0):l=rcmail.html2plain(r,d),!l&&n&&this.editor.dom.setHTML("_rc_sig",n)}return l},this.spellcheck_start=function(){this.editor?(tinymce.execCommand("mceSpellCheck",!0),this.spellcheck_observer()):this.spellchecker&&this.spellchecker.spellCheck&&this.spellchecker.spellCheck()},this.spellcheck_stop=function(){var e=this.editor;e?e.plugins&&e.plugins.spellchecker&&this.spellcheck_active&&(e.execCommand("mceSpellCheck",!1),this.spellcheck_observer()):(e=this.spellchecker)&&e.state&&"ready"!=e.state&&"no_error_found"!=e.state&&$(e.spell_span).trigger("click")},this.spellcheck_state=function(){var e;return this.editor?this.spellcheck_active:(e=this.spellchecker)&&e.state?"ready"!=e.state&&"no_error_found"!=e.state:void 0},this.spellcheck_resume=function(e){var t=this.editor;t?t.plugins.spellchecker.markErrors(e):(t=this.spellchecker)&&(t.prepare(!1,!0),t.processData(e))},this.get_language=function(){return this.editor?this.editor.settings.spellchecker_language||rcmail.env.spell_lang:this.spellchecker?GOOGIE_CUR_LANG:void 0},this.set_language=function(e){var t=this.editor;t&&(t.settings.spellchecker_language=e),(t=this.spellchecker)&&t.setCurrentLanguage(e)},this.replace=function(e){var t,i=this.editor;if(!e)return!1;if(i)i.getWin().focus(),"object"==$.type(e)&&"html"in e?(e=e.html,t="html"):("object"==$.type(e)&&(e=e.text||""),e=rcmail.quote_html(e).replace(/\r?\n/g,"<br/>"),t="text"),i.selection.setContent(e,{format:t});else if(i=rcube_find_object(this.id)){var n=$(i).is(":focus")?rcmail.get_input_selection(i):{start:0,end:0},r=i.value,l=r.substring(0,n.start),s=r.substring(n.end,r.length);"object"==$.type(e)&&(e=e.text||""),i.value=l+e+s,rcmail.set_caret_pos(i,n.start+e.length),i.focus()}},this.get_content=function(e){var t,i=this.editor,n="",r=!1,l={refresh:!0,selection:!1,nosig:!1,format:"html"};return e=$.extend(l,e),e.refresh&&this.spellcheck_stop(),i?(e.selection&&(n=i.selection.getContent({format:e.format})),n||(n=i.getContent({format:e.format}),r="text"==e.format)):(i=rcube_find_object(this.id))&&(e.selection&&$(i).is(":focus")&&(n=rcmail.get_input_selection(i).text),n||(n=i.value,r=!0)),r&&e.nosig&&(t=n.indexOf("-- \n"))>0&&(n=n.substring(0,t)),n},this.change_signature=function(e,t){var i,n,r=-1,l=$("#"+this.id),s=l.val(),o=rcmail.env.identity;if(this.editor)if(t&&rcmail.env.signatures){var a=this.editor.dom.get("_rc_sig");if(!a){var c=this.editor.getBody();if(a=$('<div id="_rc_sig"></div>').get(0),rcmail.env.top_posting&&!rcmail.env.sig_below&&rcmail.env.compose_mode&&(c.childNodes.length>1||$(c).text())){this.editor.getWin().focus();var d=this.editor.selection.getNode();$(a).insertBefore("BODY"==d.nodeName?c.firstChild:d.nextSibling),$("<p>").append($("<br>")).insertBefore(a)}else c.appendChild(a),i=rcmail.env.top_posting&&rcmail.env.compose_mode?c.firstChild:$(a).prev()}a.innerHTML=rcmail.env.signatures[e]?rcmail.env.signatures[e].html:""}else rcmail.env.top_posting||(i=$(this.editor.getBody()).children().last());else t&&o&&rcmail.env.signatures&&rcmail.env.signatures[o]&&(o=rcmail.env.signatures[o].text,o=o.replace(/\r\n/g,"\n"),(r=rcmail.env.top_posting?s.indexOf(o):s.lastIndexOf(o))>=0&&(s=s.substring(0,r)+s.substring(r+o.length,s.length))),t&&rcmail.env.signatures&&rcmail.env.signatures[e]?(o=rcmail.env.signatures[e].text,o=o.replace(/\r\n/g,"\n"),r>=0?(s=s.substring(0,r)+o+s.substring(r,s.length),n=r-1):s&&rcmail.env.compose_mode?rcmail.env.top_posting&&!rcmail.env.sig_below?(pos=rcmail.get_caret_pos(l.get(0)))?(s=s.substring(0,pos)+"\n"+o+"\n\n"+s.substring(pos,s.length),n=pos):(s="\n\n"+o+"\n\n"+s.replace(/^[\r\n]+/,""),n=0):(s=s.replace(/[\r\n]+$/,""),n=!rcmail.env.top_posting&&s.length?s.length+1:0,s+="\n\n"+o):(n=s.length,s+="\n\n"+o)):n=rcmail.env.top_posting?0:s.length,l.val(s),rcmail.set_caret_pos(l.get(0),n);this.editor&&i&&i.length&&(this.editor.selection.setCursorLocation(i.get(0)),this.editor.getWin().scroll(0,i.offset().top))},this.save=function(){this.editor&&this.editor.save()},this.focus=function(){(this.editor||rcube_find_object(this.id)).focus()},this.file_browser_callback=function(e,t,n){var r,l,s,o,a=[];o=this.editor.windowManager.open({title:rcmail.get_label("select"+n),width:500,height:300,html:'<div id="image-selector-list"><ul></ul></div><div id="image-selector-form"><div id="image-upload-button" class="mce-widget mce-btn" role="button" tabindex="0"></div></div>',buttons:[{text:"Cancel",onclick:function(){i.file_browser_close()}}]}),rcmail.env.file_browser_field=e,rcmail.env.file_browser_type=n;for(r in rcmail.env.attachments)(l=i.file_browser_entry(r,rcmail.env.attachments[r]))&&a.push(l);a.length&&$("#image-selector-list > ul").append(a).find("li:first").focus(),$("div.mce-abs-end",o.getEl()).append($('<div class="hint">').text($("div.hint",rcmail.gui_objects.uploadform).text())),l=$("#image-upload-button").append($("<span>").text(rcmail.get_label("add"+n))),s=l.parents(".mce-panel").find("button:last").parent(),l.keydown(function(e){if(9==e.which)return rcube_event.get_modifier(e)==SHIFT_KEY?$("#image-selector-list li:last").focus():s.focus(),!1}),s.keydown(function(e){if(9==e.which)return rcube_event.get_modifier(e)==SHIFT_KEY?l.focus():$("#image-selector-list li:first").focus(),!1}),this.hack_file_input(l,rcmail.gui_objects.uploadform),(window.XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.sendAsBinary||window.FormData)&&(rcmail.env.filedrop||(rcmail.env.filedrop={}),rcmail.gui_objects.filedrop&&(rcmail.env.old_file_drop=rcmail.gui_objects.filedrop),rcmail.gui_objects.filedrop=$("#image-selector-form"),rcmail.gui_objects.filedrop.addClass("droptarget").on("dragover dragleave",function(e){e.preventDefault(),e.stopPropagation(),$(this)["dragover"==e.type?"addClass":"removeClass"]("hover")}).get(0).addEventListener("drop",function(e){return rcmail.file_dropped(e)},!1)),rcmail.env.file_dialog_event||(rcmail.env.file_dialog_event=!0,rcmail.addEventListener("fileuploaded",function(e){var t;(t=i.file_browser_entry(e.name,e.attachment))&&($("#image-selector-list > ul").prepend(t),t.focus())}))},this.file_browser_close=function(e){var t=$("#"+rcmail.env.file_browser_field);e&&t.val(e),this.editor.windowManager.close(),t.focus(),rcmail.env.old_file_drop&&(rcmail.gui_objects.filedrop=rcmail.env.old_file_drop)},this.file_browser_entry=function(e,t){if(t.complete&&t.mimetype){rcmail.file_upload_id&&rcmail.set_busy(!1,null,rcmail.file_upload_id);var n,r;switch(rcmail.env.file_browser_type){case"image":n=/^image\//i;break;case"media":n=/^video\//i,r="program/resources/tinymce/video.png";break;default:return}if(n.test(t.mimetype)){var l=rcmail.env.comm_path+"&_from="+rcmail.env.action,s=rcmail.env.compose_id?"&_id="+rcmail.env.compose_id+"&_action=display-attachment":"&_action=upload-display",o=l+s+"&_file="+e,a=$("<img>").attr({title:t.name,src:r||o+"&_thumbnail=1"});return $("<li>").attr({tabindex:0}).data("url",o).append($('<span class="img">').append(a)).append($('<span class="name">').text(t.name)).click(function(){i.file_browser_close($(this).data("url"))}).keydown(function(e){if(13==e.which)i.file_browser_close($(this).data("url"));else if(9==e.which)return rcube_event.get_modifier(e)==SHIFT_KEY?$(this).prev().focus().length||$("#image-upload-button").parents(".mce-panel").find("button:last").parent().focus():$(this).next().focus().length||$("#image-upload-button").focus(),!1})}}},this.hack_file_input=function(e,t){function i(e){n||(n=r.offset()),l.css({top:e.pageY-n.top-10+"px",left:e.pageX-n.left-10+"px"})}var n,r=$(e),l=$("<input>").attr("name","_file[]"),s=$("<form>").attr({method:"post",enctype:"multipart/form-data"});t&&(l.attr("name",$('input[type="file"]',t).attr("name")),s.attr("action",$(t).attr("action")).append($("<input>").attr({type:"hidden",name:"_token",value:rcmail.env.request_token}))),l.attr({type:"file",multiple:"multiple",size:5,title:"",tabindex:-1}).change(function(){rcmail.upload_file(s,"upload")}).click(function(){setTimeout(function(){r.mouseleave()},20)}).css({opacity:0,cursor:"pointer",position:"relative",outline:"none"}).appendTo(s),navigator.userAgent.match(/Firefox|MSIE/)&&l.css({marginLeft:"-80px"}),r.css({overflow:"hidden",cursor:"pointer"}).mouseenter(function(){this.__active=!0}).mousemove(function(e){this.__active?i(e):$(this).mouseleave()}).mouseleave(function(){l.css({top:"-10000px",left:"-10000px"}),this.__active=!1}).click(function(e){this.__active||(this.__active=!0,i(e),l.trigger(e))}).keydown(function(e){13==e.which&&l.trigger("click")}).mouseleave().append(s)}}